<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transcendence - Sign In</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // --- PAGE SWITCHING ---
    // header is persistent, hide/show other sections only
function showSection(section) {
  const ids = ['signin-section', 'register-section', 'forgot-section', 'reset-section', 'pong-section'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  const target = document.getElementById(section);
  if (target) target.classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('link-signin').addEventListener('click', (e) => {
    e.preventDefault();
    // header stays visible automatically
    showSection('signin-section');
  });

  document.getElementById('link-signup').addEventListener('click', (e) => {
    e.preventDefault();
    showSection('register-section');
  });

  document.getElementById('goto-register').addEventListener('click', (e) => {
    e.preventDefault();
    showSection('register-section');
  });

  document.getElementById('goto-signin').addEventListener('click', (e) => {
    e.preventDefault();
    showSection('signin-section');
  });

      // Forgot password link -> show forgot section
      document.getElementById('forgot-link').addEventListener('click', (e) => {
        e.preventDefault();
        // prefill email from username/email field if possible
        const signinForm = document.getElementById('signin-form');
        const emailOrUser = signinForm ? signinForm.querySelector('input[name="user"]') : null;
        const forgotEmail = document.getElementById('forgot-email');
        if (emailOrUser && forgotEmail) {
          forgotEmail.value = emailOrUser.value || '';
        }
        showSection('forgot-section');
      });

     // Forgot form submit -> real API call

document.getElementById('forgot-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('forgot-email').value.trim();
  const msg = document.getElementById('forgot-message');

  if (!email) {
    msg.textContent = 'Please enter your email.';
    msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
    return;
  }

  try {
    const response = await fetch('https://localhost:3000/api/auth/forgot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });

    const data = await response.json();

    if (response.ok) {
      msg.textContent = data.message || 'Email sent successfully!';
      msg.className = 'mt-3 text-sm text-green-600 dark:text-green-400';
    } else {
      msg.textContent = data.error || 'Failed to send email.';
      msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
    }
  } catch (err) {
    console.error('Error sending email:', err);
    msg.textContent = 'Network error — please try again.';
    msg.className = 'mt-3 text-sm text-red-600 dark:text-red-400';
  }
 });

      // Back to sign-in from forgot section
      document.getElementById('back-to-signin').addEventListener('click', (e) => {
        e.preventDefault();
        // clear message & email
        const msg = document.getElementById('forgot-message');
        const forgotEmail = document.getElementById('forgot-email');
        if (msg) { msg.textContent = ''; msg.className = 'mt-3 text-sm text-gray-600 dark:text-gray-400'; }
        if (forgotEmail) forgotEmail.value = '';
        showSection('signin-section');
      });
   // ✅ Detect /reset-password?token=... and show reset form
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  if (token && window.location.pathname === '/reset-password') {
    showSection('reset-section');
    document.getElementById('reset-form').dataset.token = token;
  }

  // Reset form submit
  document.getElementById('reset-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const token = form.dataset.token;
    const newPassword = document.getElementById('new-password').value.trim();
    const msg = document.getElementById('reset-message');

    if (!newPassword) {
      msg.textContent = 'Please enter a new password.';
      msg.className = 'mt-3 text-sm text-red-600';
      return;
    }

    try {
      const response = await fetch('https://localhost:3000/api/auth/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword }),
      });
      const data = await response.json();
      if (response.ok) {
        msg.textContent = 'Password reset successful! You can now sign in.';
        msg.className = 'mt-3 text-sm text-green-600';
      } else {
        msg.textContent = data.error || 'Failed to reset password.';
        msg.className = 'mt-3 text-sm text-red-600';
      }
    } catch (err) {
      msg.textContent = 'Network error — please try again.';
      msg.className = 'mt-3 text-sm text-red-600';
    }
  });
    });
  </script>

</head>

<body class="bg-gradient-to-br from-gray-100 to-white dark:from-gray-900 dark:to-gray-800 flex flex-col justify-center items-center min-h-screen transition-all duration-500 relative">
<!-- HEADER SECTION -->
<section id="header1-section"
  <!-- Top Bar -->
  <div class="absolute top-5 left-6 text-xl font-semibold text-gray-800 dark:text-gray-100 select-none">
    Transcendence
  </div>

  <!-- Navbar -->
  <div class="absolute top-5 right-6 flex items-center space-x-3">
    <a href="#" id="link-signup" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition">Sign up</a>
    <a href="#" id="link-signin" class="px-4 py-2 rounded-lg bg-blue-500 text-white text-sm hover:bg-blue-600 transition">Sign in</a>
  </div>
 </section>
  <!-- SIGN IN SECTION -->
  <section id="signin-section" class="bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
    <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Sign in</h2>

    <form id="signin-form">
      <input name="user" type="text" placeholder="Username or email"
        class="w-full mb-3 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
      <input name="password" type="password" placeholder="Password"
        class="w-full mb-3 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required>

      <div class="flex justify-between text-sm mb-4">
        <a href="#" id="goto-register" class="text-blue-500 hover:underline">Don't have an account?</a>
        <!-- updated: added id="forgot-link" -->
        <a href="#" id="forgot-link" class="text-blue-500 hover:underline">Forgot password?</a>
      </div>

      <button type="submit" id="signinBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">Sign in</button>

      <div class="my-3 text-gray-500 dark:text-gray-400 text-sm">or</div>

     <a href="https://localhost:3000/api/auth/github/login"
   class="w-full flex items-center justify-center gap-2 border border-gray-300 dark:border-gray-700 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
  <img src="https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/github.svg" class="w-5" alt="GitHub logo">
  Sign in with GitHub
</a>
      <a href="https://localhost:3000/api/auth/signin"
        class="w-full flex items-center justify-center gap-2 border border-gray-300 dark:border-gray-700 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 mt-2 transition">
        <img
          src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='14' fill='%23007ACC'/><text x='50' y='62' font-size='42' text-anchor='middle' fill='white' font-family='system-ui,Arial,sans-serif'>42</text></svg>"
          class="w-5 h-5" alt="42 logo">
        Sign in with 42 Intra
      </a>
    </form>

  </section>

  <!-- SIGN UP SECTION -->
  <section id="register-section" class="hidden bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
    <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Sign up</h2>

    <form id="register-form" class="flex flex-col gap-3">
      <input id="username" type="text" placeholder="Username"
        class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
      <input id="email" type="email" placeholder="Email"
        class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
      <input id="password" type="password" placeholder="Password"
        class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
      <button type="submit" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Sign up</button>
    </form>

    <p id="register-message" class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400"></p>
    <p class="text-sm mt-3 text-gray-500 dark:text-gray-400">Already have an account?
      <a href="#" id="goto-signin" class="text-blue-500 hover:underline">Sign in</a>
    </p>

  </section>

  <!-- FORGOT PASSWORD SECTION -->
  <section id="forgot-section" class="hidden bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-8 w-80 sm:w-96 text-center transition-all duration-500">
    <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Reset password</h2>

    <form id="forgot-form" class="flex flex-col gap-3">
      <label for="forgot-email" class="sr-only">Email address</label>
      <input id="forgot-email" type="email" placeholder="Enter your email"
        class="border p-2 rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400" required />

      <button type="submit" class="bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Send reset link</button>

      <p id="forgot-message" class="mt-3 text-sm text-gray-600 dark:text-gray-400"></p>

      <button id="back-to-signin" class="mt-4 text-sm text-gray-500 dark:text-gray-400 hover:underline">← Back to sign in</button>
    </form>
  </section>

<section id="reset-section" class="hidden">
  <h2>Reset Password</h2>
  <form id="reset-form">
    <input type="password" id="new-password" placeholder="New password" required />
    <button type="submit">Reset Password</button>
    <p id="reset-message" class="mt-3 text-sm"></p>
  </form>
</section>

    <!-- PONG DASHBOARD SECTION -->
<section id="pong-section" class="hidden flex flex-col min-h-screen w-full bg-gray-100 dark:bg-gray-900 transition-all duration-500">
  <!-- Header -->
  <header class="w-full bg-gray-800 text-gray-100 shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex items-center justify-between h-16" aria-label="Pong navigation">

        <!-- Brand -->
        <div class="flex items-center space-x-3">
          <span class="text-lg font-semibold select-none">Transcendence Pong</span>
        </div>

        <!-- Navigation Buttons -->
        <div class="hidden md:flex items-center gap-3">
          <button id="homeBtn" class="px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-blue-400">Home</button>
          <button id="tournamentBtn" class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-green-400">Tournament</button>
          <button id="playersBtn" class="px-3 py-1 rounded-md bg-purple-600 hover:bg-purple-700 focus:ring-2 focus:ring-purple-400">Players</button>
          <button id="matchesBtn" class="px-3 py-1 rounded-md bg-yellow-500 hover:bg-yellow-600 focus:ring-2 focus:ring-yellow-400">Matches</button>
        </div>

        <!-- User Controls -->
        <div class="flex items-center space-x-3">

          <!-- User Info -->
          <div class="flex items-center space-x-2">
            <img class="h-8 w-8 rounded-full border border-gray-600" src="https://i.pravatar.cc/40?img=12" alt="User avatar">
            <span class="hidden md:inline text-sm font-medium text-gray-200">@Aurelien</span>
          </div>

          <!-- Logout -->
          <a href="#" id="logoutBtn" class="px-3 py-1 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm focus:ring-2 focus:ring-blue-400">Sign out</a>
        </div>
      </nav>

      <!-- Mobile Nav -->
      <div class="md:hidden mt-2 pb-2 border-t border-gray-700">
        <div class="flex gap-2 justify-center">
          <button class="flex-1 px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700">Home</button>
          <button class="flex-1 px-3 py-2 rounded-md bg-green-600 hover:bg-green-700">Tournament</button>
          <button class="flex-1 px-3 py-2 rounded-md bg-purple-600 hover:bg-purple-700">Players</button>
          <button class="flex-1 px-3 py-2 rounded-md bg-yellow-500 hover:bg-yellow-600">Matches</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="pongContent" class="flex-1 p-8 space-y-10 text-center">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Welcome to Transcendence Pong!</h1>
    <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
      Play, compete, and rise through the ranks in the modern reimagining of the classic arcade game.
    </p>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
      <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
        <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Start a Match</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Launch a friendly or ranked game instantly.</p>
        <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">Play Now</button>
      </div>

      <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
        <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Join a Tournament</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Compete in official events and climb the leaderboard.</p>
        <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">View Tournaments</button>
      </div>

      <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
        <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-100">Leaderboard</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-4">See who’s dominating the Pong arena.</p>
        <button class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md">View Rankings</button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-gray-400 py-4 border-t border-gray-700">
    Transcendence 42 &copy; 2025 — Pong Module
  </footer>

</section>

  <!-- Scripts at the end for Vite-friendly imports -->
  <script type="module" src="./src/alias.ts"></script>
  <script type="module" src="./src/main.ts"></script>

  <!-- Minimal JS to show the Home section  -->
  <script> 
  document.getElementById('homeBtn')?.addEventListener('click', () => {
    const homeContent = document.getElementById('homeContent');
    if (homeContent) {
      homeContent.scrollIntoView({ behavior: 'smooth' });
    }
    console.log('Navigating to Home section');
  });
</script>

  <script>  
  document.addEventListener('DOMContentLoaded', () => { 
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const pathname = window.location.pathname;

    // ✅ 1. Handle /reset-password?token=... FIRST — prevents Pong from showing
    if (pathname === '/reset-password' && token) {
      // Hide everything except reset-section
      const ids = [
        'signin-section',
        'register-section',
        'forgot-section',
        'pong-section'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });

     // ✅ Show header and reset form
  	const header1Section = document.getElementById('header1-section');
  	const resetSection = document.getElementById('reset-section');

  	if (header1Section) header1Section.classList.remove('hidden');
  	if (resetSection) resetSection.classList.remove('hidden');
     	 const resetForm = document.getElementById('reset-form');
      	if (resetForm) resetForm.dataset.token = token;

      	// Clean the URL (remove token)
     	 const cleanUrl = window.location.origin + window.location.pathname;
      	window.history.replaceState({}, document.title, cleanUrl);

      	return;
    	}

    // ===========================
    // Normal Auth / Pong Handling
    // ===========================
    const header1Section = document.getElementById('header1-section');
    const signinSection = document.getElementById('signin-section');
    const registerSection = document.getElementById('register-section');
    const pongSection = document.getElementById('pong-section');

    // Helper: show Pong UI
    function showPongSection() {
      if (header1Section) header1Section.classList.add('hidden');
      if (signinSection) signinSection.classList.add('hidden');
      if (registerSection) registerSection.classList.add('hidden');
      if (pongSection) pongSection.classList.remove('hidden');
    }

    // Helper: show Sign-In UI
    function showSigninSection() {
      if (header1Section) header1Section.classList.remove('hidden');
      if (signinSection) signinSection.classList.remove('hidden');
      if (registerSection) registerSection.classList.add('hidden');
      if (pongSection) pongSection.classList.add('hidden');
    }

    // --- STEP 1: Handle redirect with ?token=... (JWT from login)
    if (token) {
      sessionStorage.setItem('jwt', token);

      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);

      showPongSection();
      return;
    }

    // --- STEP 2: Returning user (already signed in)
    const storedToken = sessionStorage.getItem('jwt');
    if (storedToken) {
      showPongSection();
    } else {
      showSigninSection();
    }
    // --- STEP 3: Logout button handler
   const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        sessionStorage.removeItem('jwt');
        showSigninSection();
      });
    }
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const signinForm = document.getElementById('signin-form');

  signinForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const user = e.target.user.value.trim();
    const password = e.target.password.value.trim();

    if (!user || !password) {
      alert('Please enter both username and password.');
      return;
    }

    try {
      const res = await fetch('https://localhost:3000/api/auth/signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, password }),
      });

      const data = await res.json();

      if (res.ok && data.token) {
        // Save token and show Pong section
        sessionStorage.setItem('token', data.token);
        document.getElementById('header1-section').classList.add('hidden');
        document.getElementById('signin-section').classList.add('hidden');
        document.getElementById('register-section').classList.add('hidden');
        document.getElementById('pong-section').classList.remove('hidden');
      } else {
        alert(data.error || 'Invalid credentials');
      }
    } catch (err) {
      alert('Network error — please try again.');
    }
  });
});
</script>
</body>
</html>
